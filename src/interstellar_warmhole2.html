<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Interstellar</title>

    <script type="text/javascript" src="js/three.min.js"></script>
    <script type="text/javascript" src="js/threeM.js"></script>
    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>

</head>
<style>
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        margin: 0px;
        overflow: hidden;
        width:100%;
        height:100%;
    }

    #overlay {
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background-color: black;
        opacity: 0;
        -webkit-transition:opacity 0.6s ease-out;
        transition:opacity 0.6s ease-out;
        z-index: 999;
    }

    #overlay.show {
        opacity: 1;
    }

    #overlay h1 {
        color: white;
        text-align: center;
        top: 50%;
        position: relative;
        -webkit-transform: translate3d(0,-50%,0);
        transform: translate3d(0,-50%,0);
    }

    #tunnel {
        position:absolute;
        left:0;
        top:0;
        width:100%;
        height:100%;
    }

    #tunnel2 {
        position:absolute;
        left:0;
        top:0;
        width:100%;
        height:100%;
    }


</style>
<body>

<script type="text/vertexShader" id="vertexShader">
    varying vec3 iRay;
    varying vec2 vUv;
    void main() {
            vUv = uv;
            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0 );
            gl_Position = projectionMatrix * mvPosition;
    }


</script>
<script type="text/fragmentShader" id="fragmentShader">
        uniform float iGlobalTime;
        varying vec2 vUv;
        uniform vec2 iResolution;
        uniform sampler2D iChannel0;
        uniform sampler2D iChannel1;

        //Adjust Color
        uniform float iRedColor;
        uniform float greenColor;
        uniform float blueColor;
        uniform float iColorsDist;

        #define GAMMA (2.2)
        vec3 ToGamma( in vec3 col )
        {
            // convert back into colour values, so the correct light will come out of the monitor
            return pow( col, vec3(1.0/GAMMA) );
        }

        vec4 Noise( in ivec2 x )
        {
            return texture2D( iChannel0, (vec2(x)+0.5)/256.0, -100.0 );
        }

        void main(void) {
            vec3 ray;
            ray.xy = 2.0*(gl_FragCoord.xy-iResolution.xy*.5)/iResolution.x;
            ray.z = 1.0;

            float offset = iGlobalTime*.5;
            float speed2 = (cos(offset)+1.0)*2.0;
            float speed = speed2+.1;
            /*offset += sin(offset)*.96;*/
            offset += (offset)*.96;
            offset *= 1.0;


            vec3 col = vec3(0);

            vec3 stp = ray/max(abs(ray.x),abs(ray.y));

            vec3 pos = 2.0*stp+.5;

            for ( int i=0; i < 20; i++ )
            {
                float z = Noise(ivec2(pos.xy)).x;
                //float z = 1;
                z = fract(z-offset);
                float d = 50.0*z-pos.z;
                float w = pow(max(0.0,1.0-8.0*length(fract(pos.xy)-.5)),2.0);
                vec3 c = max(vec3(0),vec3(iRedColor-abs(d+speed2*.5)/speed,1.0-abs(d)/speed,1.0-abs(d-speed2*.5)/speed));
                col += 1.5*(1.0-z)*c*w;
                pos += stp;
            }

            gl_FragColor = vec4(ToGamma(col),1.0);

        }
</script>


<script type="text/javascript">

    function onLoad () {
        init();
    }


    var tuniform, scene, camera, clock, renderer, mat, texture, tobject, screen_height, screen_width, delta,
            colorChangeValue = 0.01, currentLevel, startTime, isStartGame;

    currentLevel = 1;
    startTime = 1;
    isStartGame = true;

    var init = function () {
        clock = new THREE.Clock();
        clock.start();

        screen_width = window.innerWidth;
        screen_height = window.innerHeight;

        initRenderer();
        initScene();
        initCamera();
        initShaderToy();

        testTunnel2();

        render();
    };

    var initScene = function() {
        scene = new THREE.Scene();
//        document.body.appendChild(renderer.domElement);
        //tunnel
        $("#tunnel").append(renderer.domElement);
    };

    var initCamera =  function() {
        camera = new THREE.PerspectiveCamera(70, screen_width / screen_height, 1, 1000);
        camera.position.set(0, 0, -100);
        camera.lookAt(scene.position);
    };

    var initRenderer = function() {
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(screen_width, screen_height);
    };

    var initShaderToy = function() {
        tuniform = {
            iGlobalTime:    { type: 'f', value: 0.1 },
            iRay: { type: 'v3', value: 0},
            iChannel0:  { type: 't', value: THREE.ImageUtils.loadTexture('images/textures/sphere.png') },
            iResolution : { type: "v2", value : new THREE.Vector2(screen_width,screen_height) },
            iRedColor :  {type: "f", value :0.0 },
            iColorsDist: {type: "f", value :0.0 }
        };

        tuniform.iChannel0.value.wrapS = tuniform.iChannel0.value.wrapT = THREE.RepeatWrapping;
        tuniform.iRay.needsUpdate = true;

        mat = new THREE.ShaderMaterial(
                {
                    uniforms: tuniform,
                    vertexShader: document.getElementById("vertexShader").textContent,
                    fragmentShader: document.getElementById("fragmentShader").textContent,
                    side:THREE.DoubleSide
                }
        );

        tobject = new THREE.Mesh( new THREE.PlaneGeometry(screen_width, screen_height,1,1), mat);
        scene.add(tobject);
    };

    var render = function () {
        requestAnimationFrame(render);
//        delta=clock.getDelta();

        if(currentLevel === 1) {
//            tuniform.iGlobalTime.value += delta;
//            if(tuniform.iRedColor.value > 1 || tuniform.iRedColor.value < 0) {
//                colorChangeValue *= -1;
//            }
//            tuniform.iRedColor.value += colorChangeValue;
            renderer.render(scene, camera);
        }else if(currentLevel === 2){

           /* texture2.offset.y	+= 0.008; //control the speed of tunnel
            texture2.offset.y	%= 1;
            texture2.needsUpdate	= true;

            // move the camera back and forth
            var seconds		= Date.now() / 1000;
            var radius		= 0.70;
            var angle		= Math.sin(0.75 * seconds * Math.PI) / 4;
            //angle	= (seconds*Math.PI)/4;
            camera2.position.x	= Math.cos(angle - Math.PI/2) * radius;
            camera2.position.y	= Math.sin(angle - Math.PI/2) * radius + 0.5;
            camera2.rotation.z	= angle;*/
            renderer2.render(scene2, camera2);
        }
    };



    /**/
    var deleteShader = function() {
        scene.remove(tobject);
        $("#tunnel").empty();

    };

    var scene2, camera2,  renderer2, mat2, texture2, tobject2;
    function testTunnel2() {


        setTimeout(function(){
            initTunnel2();
            $("#tunnel").append(renderer2.domElement);
        },10);
    }

    /*init Other */

    function initTunnel2(){
        currentLevel = 2;
        renderer2 = new THREE_M.WebGLRenderer({
            antialias: true,
            alpha: false
        });

        renderer2.setClearColor( 0xff0000, 1 );

        renderer2.setSize( window.innerWidth, window.innerHeight );
//        document.getElementById('container').appendChild(renderer.domElement);

        scene2 = new THREE_M.Scene();

        camera2 = new THREE_M.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000 );
//        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 100);
        camera2.position.set(0, 0, 7);
        camera2.lookAt(scene2.position);
        scene2.add(camera2);

        var light	= new THREE_M.DirectionalLight( 0xff8000, 1.5 );
        light.position.set( 1, 1, 0 ).normalize();
        scene2.add( light );

        var light	= new THREE_M.DirectionalLight( 0xff8000, 1.5 );
        light.position.set( -1, 1, 0 ).normalize();
        scene2.add( light );

        var light	= new THREE_M.PointLight( 0x44FFAA, 15, 25 );
        light.position.set( 0, -3, 0 );
        scene2.add( light );

        var light	= new THREE_M.PointLight( 0xff4400, 20, 30 );
        light.position.set( 3, 3, 0 );
        scene2.add( light );

        scene2.fog	= new THREE_M.FogExp2( 0x000000, 0.15 );

        var geometry	= new THREE_M.CylinderGeometry( 1, 1, 30, 32, 1, true );
        texture2	= THREE_M.ImageUtils.loadTexture( "images/textures/ash_uvgrid01.jpg" );
        texture2.wrapT	= THREE_M.RepeatWrapping;

        var material	= new THREE_M.MeshLambertMaterial({color : 0xFFFFFF, map : texture2});
        var mesh	= new THREE_M.Mesh( geometry, material );
        mesh.rotation.x	= Math.PI/2;
        scene2.add( mesh );

        mesh.flipSided	= true;

    }




    //segments more polygons//
    //radiusSegments number of strip

    var showOverlay = function() {
        var iOverlay = $('#overlay');
        iOverlay.addClass('show');
        animate.transitionEnd(iOverlay, onFinishShowOverlay);
    };

    var onFinishShowOverlay = function() {
        deleteShader();

        testTunnel2();
//        initRainbowSetup();
        isStartGame = false;

        setTimeout(function(){
            startCountDown();
        },700);
    };

    var hideOverlay = function() {
        var iOverlay = $('#overlay');
        iOverlay.removeClass('show');
        animate.transitionEnd(iOverlay, onFinishHideOverlay);
    };

    var onFinishHideOverlay = function() {
        console.log("???");
    };

    var startCountDown = function() {
        var countDown = setInterval(function(){
            $('#message').html(startTime);
            if(startTime > 0) {
                startTime -=1;
            }else {
                hideOverlay();
                isStartGame = true;
//                console.log("start level 2");
            }
        },500);
    };

    var animate = {
        transitionEnd: function(ele, callbackFunc) {
            $(ele).unbind('webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd');
            $(ele).bind('webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd', function() {
                $(ele).unbind('webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd');
                if (callbackFunc) {
                    callbackFunc.apply();
                }
            });
        }
    };

    window.addEventListener('load',onLoad);
</script>

<button style="z-index: 1000; position:absolute; bottom:0; right:0;" onclick="showOverlay()">close</button>

<div id="overlay">
    <h1 id="message">Ready For Level 3?</h1>
</div>

<div id="tunnel"></div>
<!--<div id="tunnel2"></div>-->



</body>
</html>